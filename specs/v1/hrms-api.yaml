openapi: 3.0.3

info:
  title: "HRMS API"
  description: |
    API definition for the SME Human Resource Management System.
    
    **Key Modules:**
    - Authentication (JWT)
    - Employee Management (Core Data)
    - Attendance & Leave (Planned)
    - Payroll (Planned)
  version: "1.0.0"
  contact:
    name: "HRMS Platform Team"
    email: "api-support@hrms.internal"

servers:
  - url: "https://api.hrms.internal/v1"
    description: "Production Server"
  - url: "https://api.staging.hrms.internal/v1"
    description: "Staging Server"

# GLOBAL SECURITY (Style Guide E.1)
# By default, all endpoints require a Bearer Token.
security:
  - bearerAuth: []

tags:
  - name: "Authentication"
    description: "User login and session management."
  - name: "Employees"
    description: "Employee profile management (CRUD)."
  - name: "Attendance"
    description: "Daily attendance tracking."
  - name: "Leave"
    description: "Leave request workflows (Submit -> Approve/Reject)."
  - name: "Payroll"
    description: "Payroll calculation and payslip management."

paths:
  # ============================================================
  # PAYROLL DOMAIN (UC-07, UC-08, FR-14 to FR-16)
  # ============================================================
  /payroll-runs:
    post:
      tags:
        - "Payroll"
      summary: "Generate Monthly Payroll"
      description: |
        Trigger the payroll calculation for a specific month.
        - Calculates Net Salary for all **Active** employees.
        - Overwrites existing records for the same month.
        - **Admin only**.
      operationId: "generatePayroll"
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GeneratePayrollRequest'
      responses:
        '200':
          description: "Payroll generated successfully."
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PayrollRunSummary'
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/Forbidden'

  /payslips:
    get:
      tags:
        - "Payroll"
      summary: "List Payslips"
      description: |
        Retrieve generated payslips.
        - **Employees** see only their own.
        - **Admins** can see all.
      operationId: "listPayslips"
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/LimitParam'
        - $ref: '#/components/parameters/AfterParam'
        - name: filter[month]
          in: query
          required: true
          description: "The month to retrieve (YYYY-MM)."
          schema:
            type: string
            pattern: '^\d{4}-\d{2}$'
            example: "2025-10"
        - name: filter[employeeId]
          in: query
          description: "Filter by employee (Admin only)."
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: "Successful response."
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PayslipConnection'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /payroll-reports/export:
    get:
      tags:
        - "Payroll"
      summary: "Export Payroll Report"
      description: |
        Download the monthly payroll summary as an Excel file.
        - **Admin only**.
      operationId: "exportPayrollReport"
      security:
        - bearerAuth: []
      parameters:
        - name: month
          in: query
          required: true
          description: "The month to export (YYYY-MM)."
          schema:
            type: string
            pattern: '^\d{4}-\d{2}$'
            example: "2025-10"
      responses:
        '200':
          description: "Excel file generated."
          content:
            application/vnd.openxmlformats-officedocument.spreadsheetml.sheet:
              schema:
                type: string
                format: binary
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
  # ============================================================
  # AUTHENTICATION DOMAIN (UC-01)
  # ============================================================
  /auth/login:
    post:
      tags:
        - "Authentication"
      summary: "User Login"
      description: "Authenticates a user via email and password, returning a JWT access token."
      operationId: "loginUser"
      # Override global security: Login is public
      security: [] 
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: "Login successful."
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # ============================================================
  # EMPLOYEE DOMAIN (UC-02, UC-03, FR-04 to FR-08)
  # ============================================================
  /employees:
    get:
      tags:
        - "Employees"
      summary: "List Employees"
      description: |
        Retrieve a paginated list of employees.
        - **Admins** can see all employees.
        - **Managers** can only see employees in their department (enforced by backend).
      operationId: "listEmployees"
      security:
        - bearerAuth: []
      parameters:
        # Pagination (Style Guide F.2)
        - $ref: '#/components/parameters/LimitParam'
        - $ref: '#/components/parameters/AfterParam'
        # Filtering (Style Guide F.3)
        - name: filter[department]
          in: query
          description: "Filter by department name."
          schema:
            type: string
        - name: filter[status]
          in: query
          description: "Filter by employee status (active/inactive)."
          schema:
            type: string
            enum: [active, inactive]
      responses:
        '200':
          description: "Successful response."
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EmployeeConnection'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    post:
      tags:
        - "Employees"
      summary: "Create Employee"
      description: "Create a new employee profile. (Admin only)"
      operationId: "createEmployee"
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateEmployeeRequest'
      responses:
        '201':
          description: "Employee created successfully."
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Employee'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /employees/{employeeId}:
    get:
      tags:
        - "Employees"
      summary: "Get Employee Details"
      description: "Retrieve detailed information for a specific employee."
      operationId: "getEmployeeById"
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/EmployeeIdParam'
      responses:
        '200':
          description: "Successful response."
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Employee'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags:
        - "Employees"
      summary: "Update Employee"
      description: |
        Update specific fields of an employee profile.
        - To **Deactivate** (Soft Delete), set `status` to `inactive`.
        - **Admins** can update all fields.
        - **Employees** can only update `phone`, `address`, `personalEmail`.
      operationId: "updateEmployee"
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/EmployeeIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateEmployeeRequest'
      responses:
        '200':
          description: "Employee updated successfully."
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Employee'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  # ============================================================
  # ATTENDANCE DOMAIN
  # ============================================================
  /attendance:
    get:
      tags:
        - "Attendance"
      summary: "List Attendance Records"
      description: "Retrieve attendance logs."
      operationId: "listAttendance"
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/LimitParam'
        - $ref: '#/components/parameters/AfterParam'
        - name: filter[employeeId]
          in: query
          description: "Filter by specific employee."
          schema:
            type: string
            format: uuid
        - name: filter[month]
          in: query
          description: "Filter by month (YYYY-MM)."
          schema:
            type: string
            pattern: '^\d{4}-\d{2}$'
            example: "2025-10"
      responses:
        '200':
          description: "Successful response."
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AttendanceConnection'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags:
        - "Attendance"
      summary: "Upsert Attendance Record"
      description: "Create or Update an attendance record."
      operationId: "upsertAttendance"
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpsertAttendanceRequest'
      responses:
        '200':
          description: "Record saved successfully."
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AttendanceRecord'
        '400':
          $ref: '#/components/responses/BadRequest'
        '403':
          $ref: '#/components/responses/Forbidden'

  # ============================================================
  # LEAVE DOMAIN
  # ============================================================
  /leave-requests:
    get:
      tags:
        - "Leave"
      summary: "List Leave Requests"
      description: "Retrieve leave history or pending requests."
      operationId: "listLeaveRequests"
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/LimitParam'
        - $ref: '#/components/parameters/AfterParam'
        - name: filter[status]
          in: query
          schema:
            type: string
            enum: [pending, approved, rejected]
      responses:
        '200':
          description: "Successful response."
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LeaveRequestConnection'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags:
        - "Leave"
      summary: "Submit Leave Request"
      description: "Employee submits a new leave request."
      operationId: "createLeaveRequest"
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateLeaveRequest'
      responses:
        '201':
          description: "Request submitted successfully."
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LeaveRequest'
        '400':
          $ref: '#/components/responses/BadRequest'

  /leave-requests/{requestId}:
    get:
      tags:
        - "Leave"
      summary: "Get Leave Request Details"
      description: "Retrieve full details of a specific leave request."
      operationId: "getLeaveRequestById"
      security:
        - bearerAuth: []
      parameters:
        - name: requestId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: "Successful response."
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LeaveRequest'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags:
        - "Leave"
      summary: "Approve/Reject Leave Request"
      description: "Manager or Admin updates the status of a request."
      operationId: "updateLeaveRequestStatus"
      security:
        - bearerAuth: []
      parameters:
        - name: requestId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateLeaveStatusRequest'
      responses:
        '200':
          description: "Status updated successfully."
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LeaveRequest'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

# ============================================================
# COMPONENTS (Must be at the root level, NOT indented under paths)
# ============================================================
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    LimitParam:
      name: limit
      in: query
      description: "Max number of items to return (default 25)."
      schema:
        type: integer
        default: 25
        maximum: 100
    AfterParam:
      name: after
      in: query
      description: "Cursor for the next page."
      schema:
        type: string
    EmployeeIdParam:
      name: employeeId
      in: path
      required: true
      description: "The unique identifier of the employee."
      schema:
        type: string
        format: uuid

  responses:
    BadRequest:
      description: "Validation error."
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Unauthorized:
      description: "Missing or invalid token."
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Forbidden:
      description: "Insufficient permissions."
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: "Resource not found."
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    InternalServerError:
      description: "Server error."
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  schemas:
    # --- PAYROLL SCHEMAS ---
    GeneratePayrollRequest:
      type: object
      required:
        - month
      properties:
        month:
          type: string
          pattern: '^\d{4}-\d{2}$'
          example: "2025-10"
        standardWorkingDays:
          type: number
          default: 22
          description: "Standard working days in this month (e.g., 22 or 26)."

    PayrollRunSummary:
      type: object
      required:
        - month
        - processedCount
        - totalPayout
      properties:
        month:
          type: string
        processedCount:
          type: integer
          description: "Number of employees processed."
        totalPayout:
          type: number
          description: "Total net salary calculated."
        generatedAt:
          type: string
          format: date-time

    Payslip:
      type: object
      required:
        - id
        - employee
        - month
        - netSalary
      properties:
        id:
          type: string
          format: uuid
        employee:
          $ref: '#/components/schemas/EmployeeSummary'
        month:
          type: string
          example: "2025-10"
        standardWorkingDays:
          type: number
        actualWorkedDays:
          type: number
        basicSalary:
          type: number
        allowance:
          type: number
        bonus:
          type: number
        deduction:
          type: number
        netSalary:
          type: number
          description: "(Basic / Standard * Actual) + Allowance + Bonus - Deduction"
        generatedAt:
          type: string
          format: date-time

    PayslipConnection:
      type: object
      required:
        - data
        - pagination
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Payslip'
        pagination:
          $ref: '#/components/schemas/PaginationInfo'
          
    # --- AUTH SCHEMAS ---
    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: "admin@hrms.internal"
        password:
          type: string
          format: password
          example: "Secret123!"

    LoginResponse:
      type: object
      required:
        - accessToken
        - tokenType
        - expiresIn
      properties:
        accessToken:
          type: string
          description: "JWT Access Token"
        tokenType:
          type: string
          example: "Bearer"
        expiresIn:
          type: integer
          description: "Token expiration in seconds"
        user:
          $ref: '#/components/schemas/EmployeeSummary'

    # --- EMPLOYEE SCHEMAS ---
    # The full employee object (Read Model)
    Employee:
      type: object
      required:
        - id
        - fullName
        - workEmail
        - status
        - department
        - jobTitle
        - joinDate
      properties:
        id:
          type: string
          format: uuid
        fullName:
          type: string
          example: "Nguyen Van A"
        workEmail:
          type: string
          format: email
          example: "a.nguyen@company.com"
        personalEmail:
          type: string
          format: email
          nullable: true
        phone:
          type: string
          nullable: true
        address:
          type: string
          nullable: true
        department:
          type: string
          example: "Engineering"
        jobTitle:
          type: string
          example: "Senior Developer"
        basicSalary:
          type: number
          description: "Visible only to Admin/HR"
          example: 15000000
        status:
          type: string
          enum: [active, inactive]
          description: "Employment status."
        joinDate:
          type: string
          format: date
          example: "2023-01-15"
        createdAt:
          type: string
          format: date-time

    # A lighter version for lists or embedding
    EmployeeSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        fullName:
          type: string
        department:
          type: string
        jobTitle:
          type: string
        role:
          type: string
          enum: [admin, manager, employee]

    # Request body for Creation
    CreateEmployeeRequest:
      type: object
      required:
        - fullName
        - workEmail
        - department
        - jobTitle
        - basicSalary
        - joinDate
        - role
      properties:
        fullName:
          type: string
        workEmail:
          type: string
          format: email
        department:
          type: string
        jobTitle:
          type: string
        basicSalary:
          type: number
          minimum: 0
        joinDate:
          type: string
          format: date
        role:
          type: string
          enum: [admin, manager, employee]

    UpdateEmployeeRequest:
      type: object
      properties:
        fullName:
          type: string
        personalEmail:
          type: string
          format: email
        phone:
          type: string
        address:
          type: string
        department:
          type: string
        jobTitle:
          type: string
        basicSalary:
          type: number
        status:
          type: string
          enum: [active, inactive]
    # --- ATTENDANCE SCHEMAS ---
    AttendanceRecord:
      type: object
      required:
        - id
        - employeeId
        - date
        - status
      properties:
        id:
          type: string
          format: uuid
        employeeId:
          type: string
          format: uuid
        date:
          type: string
          format: date
          example: "2025-10-16"
        checkInTime:
          type: string
          format: date-time
          nullable: true
        checkOutTime:
          type: string
          format: date-time
          nullable: true
        status:
          type: string
          enum: [present, absent, late, half_day]
        notes:
          type: string
          nullable: true

    UpsertAttendanceRequest:
      type: object
      required:
        - employeeId
        - date
        - status
      properties:
        employeeId:
          type: string
          format: uuid
        date:
          type: string
          format: date
        checkInTime:
          type: string
          format: date-time
          nullable: true
        checkOutTime:
          type: string
          format: date-time
          nullable: true
        status:
          type: string
          enum: [present, absent, late, half_day]
        notes:
          type: string

    AttendanceConnection:
      type: object
      required:
        - data
        - pagination
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/AttendanceRecord'
        pagination:
          $ref: '#/components/schemas/PaginationInfo'

    # --- LEAVE SCHEMAS ---
    LeaveRequest:
      type: object
      required:
        - id
        - employee
        - leaveType
        - startDate
        - endDate
        - status
        - createdAt
      properties:
        id:
          type: string
          format: uuid
        employee:
          $ref: '#/components/schemas/EmployeeSummary'
        leaveType:
          type: string
          enum: [annual, sick, unpaid]
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
        reason:
          type: string
        status:
          type: string
          enum: [pending, approved, rejected]
        rejectionReason:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        decidedAt:
          type: string
          format: date-time
          nullable: true

    CreateLeaveRequest:
      type: object
      required:
        - leaveType
        - startDate
        - endDate
        - reason
      properties:
        leaveType:
          type: string
          enum: [annual, sick, unpaid]
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
        reason:
          type: string
          minLength: 5

    UpdateLeaveStatusRequest:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [approved, rejected]
        rejectionReason:
          type: string
          description: "Required if status is rejected."

    LeaveRequestConnection:
      type: object
      required:
        - data
        - pagination
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/LeaveRequest'
        pagination:
          $ref: '#/components/schemas/PaginationInfo'

    # --- PAGINATION WRAPPER ---
    EmployeeConnection:
      type: object
      required:
        - data
        - pagination
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Employee'
        pagination:
          $ref: '#/components/schemas/PaginationInfo'

    PaginationInfo:
      type: object
      required:
        - hasNextPage
      properties:
        nextCursor:
          type: string
          nullable: true
        hasNextPage:
          type: boolean

    # --- STANDARD ERROR ---
    ErrorResponse:
      type: object
      required:
        - traceId
        - code
        - message
      properties:
        traceId:
          type: string
          format: uuid
        code:
          type: string
          example: "validation_error"
        message:
          type: string
          example: "The request failed validation."
        details:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              issue:
                type: string